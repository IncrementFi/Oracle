<!DOCTYPE html>
<meta charset="utf-8">
<style>
    .link {
        fill: none;
        stroke: #555;
        stroke-opacity: 0.4;
        stroke-width: 1px;
    }
    text {
        font-family: "Arial Black", Gadget, sans-serif;
        fill: black;
        font-weight: bold;
        font-size: 14px
    }

    .xAxis .tick text{
        fill: black;
    }
    .grid .tick line{
        stroke: grey;
        stroke-dasharray: 5, 10;
        opacity: 0.7;
    }
    .grid path{
        stroke-width: 0;
    }

    .node circle {
        fill: #999;
    }
    .node--internal circle {
        fill: #555;
    }
    .node--internal text {
        font-size: 16px;
        text-shadow: 0 2px 0 #fff, 0 -2px 0 #fff, 2px 0 0 #fff, -2px 0 0 #fff;
    }
    .node--leaf text {
        fill: white;
    }
    .ballG text {
        fill: white;
    }

    .shadow {
        -webkit-filter: drop-shadow( -1.5px -1.5px 1.5px #000 );
        filter: drop-shadow( -1.5px -1.5px 1.5px #000 );
    }
    .network-badge {
        order: 1;
        font-weight: bold;
        width: 100px;
        color: #13BF69;
        margin: auto;
        background-color: #00000020;
        height: 17px;
        padding: 5px;
        border-radius: 4px;
        text-align: center;
        line-height: 17px;
        cursor: default;
    }
</style>
<head>
    <title>Oracle States</title>
</head>
<body>
    <h1 style="text-align:center">
        
        <img height="40" width="40" src="https://i.postimg.cc/1zJhY4fj/increment.png">
        Price Oracle States
        on Flow
        <img height="40" width="40" src="https://i.postimg.cc/FHdSDJzT/flow.png">
    </h1>
    
    <div class="network-badge">Testnet</div>

    <p style="text-align:center">by <a href="https://increment.fi/" style="color:#5584f7;">Increment Labs</a></p>
    <svg width="960" height="1600"></svg>
</body>

<script src="https://d3js.org/d3.v4.min.js"></script>
<script>

    // main svg
    const GREEN = "#00eb84"
    const RED = "#ff3b5b"
    const GRAY = "#999999"

    const screenX = document.body.clientWidth
    const screenY = document.body.clientHeight

    var svg = d3.select("svg"),
            width = +svg.attr("width"),
            height = +svg.attr("height"),
            g = svg.append("g").attr("transform", "translate(20,0)");       // move right 20px.
    svg.attr("transform", function(d) {
                    return "translate(" + 100 + "," + 0 + ")";
                })

    // Setting up a way to handle the data
    var tree = d3.cluster()                 // This D3 API method setup the Dendrogram datum position.
            .size([height, width - 260])    // Total width - bar chart width = Dendrogram chart width
            .separation(function separate(a, b) {
                return a.parent == b.parent            // 2 levels tree grouping for category
                || a.parent.parent == b.parent
                || a.parent == b.parent.parent ? 0.4 : 0.8;
            });

    var stratify = d3.stratify()            // This D3 API method gives cvs file flat data array dimensions.
            .parentId(function(d) { return d.id.substring(0, d.id.lastIndexOf(".")); });
    
    var data_clear = {
        "PriceState": {
            "FLOW/USD": {
                "binance": "Loading",
                "okex": "Loading",
                "huobi": "Loading",
                "kraken": "Loading",
                "coinlist": "Loading"
            },
            "USDT/USD": {
                "kraken": "Loading",
                "ftx": "Loading",
                "coinbase": "Loading",
                "bitfinex": "Loading",
                "binanceUS": "Loading"
            },
            "BLT/USD": {
                "ftx": "Loading",
                "gateio": "Loading"
            }
        },
        "UpdatePrice": {
            "USDT/USD": {
                "price": "Loading",
                "time": 0
            },
            "BLT/USD": {
                "price": "Loading",
                "time": 0
            },
            "FLOW/USD": {
                "price": "Loading",
                "time": 0
            }
        }
    }

    data = [
        {id: 'Price', value: 0, color: GREEN},
        {id: 'Price.FLOW/USD', value: 0, color: GRAY},
        {id: 'Price.FLOW/USD.node1', value: 0, color: GRAY},
        {id: 'Price.FLOW/USD.node1.binance', value: "Loading", color: GRAY, weight: "0.45"},
        {id: 'Price.FLOW/USD.node1.okex', value: "Loading", color: GRAY, weight: 0.25},
        {id: 'Price.FLOW/USD.node1.huobi', value: "Loading", color: GRAY, weight: 0.2},
        {id: 'Price.FLOW/USD.node1.kraken', value: "Loading", color: GRAY, weight: 0.08},
        {id: 'Price.FLOW/USD.node1.coinlist', value: "Loading", color: GRAY, weight: 0.02},

        {id: 'Price.FLOW/USD.node2', value: 0, color: GRAY},
        {id: 'Price.FLOW/USD.node2.binance', value: "Loading", color: GRAY, weight: 0.45},
        {id: 'Price.FLOW/USD.node2.okex', value: "Loading", color: GRAY, weight: 0.25},
        {id: 'Price.FLOW/USD.node2.huobi', value: "Loading", color: GRAY, weight: 0.2},
        {id: 'Price.FLOW/USD.node2.kraken', value: "Loading", color: GRAY, weight: 0.08},
        {id: 'Price.FLOW/USD.node2.coinlist', value: "Loading", color: GRAY, weight: 0.02},

        {id: 'Price.FLOW/USD.node3', value: 0, color: GRAY},
        {id: 'Price.FLOW/USD.node3.binance', value: "Loading", color: GRAY, weight: 0.45},
        {id: 'Price.FLOW/USD.node3.okex', value: "Loading", color: GRAY, weight: 0.25},
        {id: 'Price.FLOW/USD.node3.huobi', value: "Loading", color: GRAY, weight: 0.2},
        {id: 'Price.FLOW/USD.node3.kraken', value: "Loading", color: GRAY, weight: 0.08},
        {id: 'Price.FLOW/USD.node3.coinlist', value: "Loading", color: GRAY, weight: 0.02},

        {id: 'Price.FLOW/USD.node4', value: 0, color: GRAY},
        {id: 'Price.FLOW/USD.node4.binance', value: "Loading", color: GRAY, weight: 0.45},
        {id: 'Price.FLOW/USD.node4.okex', value: "Loading", color: GRAY, weight: 0.25},
        {id: 'Price.FLOW/USD.node4.huobi', value: "Loading", color: GRAY, weight: 0.2},
        {id: 'Price.FLOW/USD.node4.kraken', value: "Loading", color: GRAY, weight: 0.08},
        {id: 'Price.FLOW/USD.node4.coinlist', value: "Loading", color: GRAY, weight: 0.02},

        {id: 'Price.FLOW/USD.node5', value: 0, color: GRAY},
        {id: 'Price.FLOW/USD.node5.binance', value: "Loading", color: GRAY, weight: 0.45},
        {id: 'Price.FLOW/USD.node5.okex', value: "Loading", color: GRAY, weight: 0.25},
        {id: 'Price.FLOW/USD.node5.huobi', value: "Loading", color: GRAY, weight: 0.2},
        {id: 'Price.FLOW/USD.node5.kraken', value: "Loading", color: GRAY, weight: 0.08},
        {id: 'Price.FLOW/USD.node5.coinlist', value: "Loading", color: GRAY, weight: 0.02},
        /////////////
        {id: 'Price.USDT/USD', value: 0, color: GRAY},
        {id: 'Price.USDT/USD.node1', value: 0, color: GRAY},
        {id: 'Price.USDT/USD.node1.kraken', value: "Loading", color: GRAY, weight: 0.4},
        {id: 'Price.USDT/USD.node1.ftx', value: "Loading", color: GRAY, weight: 0.35},
        {id: 'Price.USDT/USD.node1.coinbase', value: "Loading", color: GRAY, weight: 0.15},
        {id: 'Price.USDT/USD.node1.bitfinex', value: "Loading", color: GRAY, weight: 0.07},
        {id: 'Price.USDT/USD.node1.binanceUS', value: "Loading", color: GRAY, weight: 0.03},

        {id: 'Price.USDT/USD.node2', value: 0, color: GRAY},
        {id: 'Price.USDT/USD.node2.kraken', value: "Loading", color: GRAY, weight: 0.4},
        {id: 'Price.USDT/USD.node2.ftx', value: "Loading", color: GRAY, weight: 0.35},
        {id: 'Price.USDT/USD.node2.coinbase', value: "Loading", color: GRAY, weight: 0.15},
        {id: 'Price.USDT/USD.node2.bitfinex', value: "Loading", color: GRAY, weight: 0.07},
        {id: 'Price.USDT/USD.node2.binanceUS', value: "Loading", color: GRAY, weight: 0.03},
        
        {id: 'Price.USDT/USD.node3', value: 0, color: GRAY},
        {id: 'Price.USDT/USD.node3.kraken', value: "Loading", color: GRAY, weight: 0.4},
        {id: 'Price.USDT/USD.node3.ftx', value: "Loading", color: GRAY, weight: 0.35},
        {id: 'Price.USDT/USD.node3.coinbase', value: "Loading", color: GRAY, weight: 0.15},
        {id: 'Price.USDT/USD.node3.bitfinex', value: "Loading", color: GRAY, weight: 0.07},
        {id: 'Price.USDT/USD.node3.binanceUS', value: "Loading", color: GRAY, weight: 0.03},

        {id: 'Price.USDT/USD.node4', value: 0, color: GRAY},
        {id: 'Price.USDT/USD.node4.kraken', value: "Loading", color: GRAY, weight: 0.4},
        {id: 'Price.USDT/USD.node4.ftx', value: "Loading", color: GRAY, weight: 0.35},
        {id: 'Price.USDT/USD.node4.coinbase', value: "Loading", color: GRAY, weight: 0.15},
        {id: 'Price.USDT/USD.node4.bitfinex', value: "Loading", color: GRAY, weight: 0.07},
        {id: 'Price.USDT/USD.node4.binanceUS', value: "Loading", color: GRAY, weight: 0.03},

        {id: 'Price.USDT/USD.node5', value: 0, color: GRAY},
        {id: 'Price.USDT/USD.node5.kraken', value: "Loading", color: GRAY, weight: 0.4},
        {id: 'Price.USDT/USD.node5.ftx', value: "Loading", color: GRAY, weight: 0.35},
        {id: 'Price.USDT/USD.node5.coinbase', value: "Loading", color: GRAY, weight: 0.15},
        {id: 'Price.USDT/USD.node5.bitfinex', value: "Loading", color: GRAY, weight: 0.07},
        {id: 'Price.USDT/USD.node5.binanceUS', value: "Loading", color: GRAY, weight: 0.03},
        ////////////
        {id: 'Price.BLT/USD', value: 0, color: GRAY},
        {id: 'Price.BLT/USD.node1', value: 0, color: GRAY},
        {id: 'Price.BLT/USD.node1.ftx', value: "Loading", color: GRAY, weight: 0.5},
        {id: 'Price.BLT/USD.node1.gateio', value: "Loading", color: GRAY, weight: 0.5},

        {id: 'Price.BLT/USD.node2', value: 0, color: GRAY},
        {id: 'Price.BLT/USD.node2.ftx', value: "Loading", color: GRAY, weight: 0.5},
        {id: 'Price.BLT/USD.node2.gateio', value: "Loading", color: GRAY, weight: 0.5},

        {id: 'Price.BLT/USD.node3', value: 0, color: GRAY},
        {id: 'Price.BLT/USD.node3.ftx', value: "Loading", color: GRAY, weight: 0.5},
        {id: 'Price.BLT/USD.node3.gateio', value: "Loading", color: GRAY, weight: 0.5},

        {id: 'Price.BLT/USD.node4', value: 0, color: GRAY},
        {id: 'Price.BLT/USD.node4.ftx', value: "Loading", color: GRAY, weight: 0.5},
        {id: 'Price.BLT/USD.node4.gateio', value: "Loading", color: GRAY, weight: 0.5},

        {id: 'Price.BLT/USD.node5', value: 0, color: GRAY},
        {id: 'Price.BLT/USD.node5.ftx', value: "Loading", color: GRAY, weight: 0.5},
        {id: 'Price.BLT/USD.node5.gateio', value: "Loading", color: GRAY, weight: 0.5},
    ]
    var g_pairPrice = {
        "Price.FLOW/USD": {
        },
        "Price.USDT/USD": {
        },
        "Price.BLT/USD": {
        },
    }
    var pairPriceMinNum = {
        "Price.FLOW/USD": 3,
        "Price.USDT/USD": 3,
        "Price.BLT/USD": 3
    }
    let nodeAddr = [
        "node1",
        "node2",
        "node3",
        "node4",
        "node5"
    ]
    
    function update(state, oracleIndex) {
        var updateOriginPrices = {}
        for (let pairName in state.PriceState) {
            for (let origin in state.PriceState[pairName]) {
                var id = "Price." + pairName + "." + nodeAddr[oracleIndex] + "." + origin
                var value = state.PriceState[pairName][origin]
                updateOriginPrices[id] = {}
                if (!isNaN(parseFloat(value))) {
                    var num = parseFloat(value).toFixed(8)
                    updateOriginPrices[id]["value"] = num
                    if (num > 0.0) {
                        updateOriginPrices[id]["color"] = GREEN
                    } else {
                        updateOriginPrices[id]["color"] = RED
                    }
                } else {
                    updateOriginPrices[id]["value"] = value
                    if (value == "Loading") {
                        updateOriginPrices[id]["color"] = GRAY
                    } else {
                        updateOriginPrices[id]["color"] = RED
                    }
                }
            }
        }
        var updateTx = {}
        for (let pairName in state.UpdatePrice) {
            var id = "Price." + pairName + "." + nodeAddr[oracleIndex]
            var value = state.UpdatePrice[pairName].price

            let localtime = new Date();
            let utc = localtime.getTime()/1000
            var deltTime = utc - state.UpdatePrice[pairName].time
            var timeStr = parseInt(deltTime/60)+"m "+parseInt(deltTime)%60+"s"

            updateTx[id] = {}
            updateTx[id].since = timeStr
            if (isNaN(parseFloat(value))) {
                updateTx[id].value = value
                if (value == "Loading") {
                    updateTx[id]["color"] = GRAY
                    deltTime = 0
                    updateTx[id].since = "0s"
                } else {
                    updateTx[id]["color"] = RED
                    g_pairPrice['Price.'+pairName][id] = 0.0
                }
            } else {
                var num = parseFloat(value).toFixed(8)
                updateTx[id].value = parseFloat(value).toFixed(8)
                g_pairPrice['Price.'+pairName][id] = value
                if (num > 0.0) {
                    updateTx[id]["color"] = GREEN
                } else {
                    updateTx[id]["color"] = RED
                }
            }
            if (deltTime/60 > 25.0) {
                updateTx[id].color = RED
            }
        }

        var leafNodeAll = g.selectAll(".node--leaf").each(
            function(d, i) {
                var id = d.id
                if (id in updateOriginPrices) {
                    var newData = updateOriginPrices[id]
                    var cur = d3.select(this)
                    var leaf = cur.select("g.node--leaf-g")
                    leaf.select("rect.shadow").style("fill", function (d) {
                        return newData.color;
                    });
                    leaf.select("text#value").text(function (d) {
                        return newData.value;
                    });
                }
            }
        )
        var leafNodeAll = g.selectAll(".node--internal").each(
            function(d, i) {
                var id = d.id
                if (id in updateTx) {
                    var newData = updateTx[id]
                    var cur = d3.select(this)
                    cur.select("rect.shadow").style("fill", function (d) {
                        return newData.color;
                    });
                    cur.select("text#value").text(function (d) {
                        return newData.value;
                    });
                    cur.select("text#time").text(function (d) {
                        return newData.since;
                    });
                }
                if (id in g_pairPrice) {
                    var data = g_pairPrice[id]
                    var pairColor = GRAY
                    var pairPrice = "Loading"
                    if (Object.keys(data).length >= pairPriceMinNum[id]) {
                        var validNum = 0;
                        var priceList = []
                        for (var subPriceId in data) {
                            var subPrice = data[subPriceId]
                            if (isNaN(parseFloat(subPrice))) {

                            } else if ( subPrice > 0.0) {
                                validNum++
                                priceList.push(subPrice)
                            }
                        }
                        if(validNum >= pairPriceMinNum[id] ) {
                            pairColor = GREEN
                            priceList.sort();
                            if(validNum%2==1) {
                                pairPrice = priceList[parseInt(priceList.length/2)]
                            } else {
                                pairPrice = (
                                        parseFloat(priceList[parseInt(priceList.length/2)-1])
                                        +
                                        parseFloat(priceList[parseInt(priceList.length/2)])
                                    )/2.0
                            }
                            pairPrice = parseFloat(pairPrice).toFixed(8)
                        } else {
                            pairColor = RED
                            pairPrice = 0.0
                        }
                    }

                    var cur = d3.select(this)
                    cur.select("rect.shadow").style("fill", function (d) {
                        return pairColor;
                    });
                    cur.select("text#value").text(function (d) {
                        return pairPrice;
                    });
                    
                }
            }
        )
    }


    function draw(data) {
        var root = stratify(data);
        tree(root);    
        // Draw every datum a line connecting to its parent.
        var link = g.selectAll(".link")
                .data(root.descendants().slice(1))
                .enter().append("path")
                .attr("class", "link")
                .attr("d", function(d) {
                    return "M" + d.y + "," + d.x
                            + "C" + (d.parent.y + 100) + "," + d.x
                            + " " + (d.parent.y + 100) + "," + d.parent.x
                            + " " + d.parent.y + "," + d.parent.x;
                });

        // Setup position for every datum; Applying different css classes to parents and leafs.
        var node = g.selectAll(".node")
                .data(root.descendants())
                .enter().append("g")
                .attr("class", function(d) {
                    return "node" + (d.children ? " node--internal" : " node--leaf"); 
                })
                .attr("transform", function(d) {
                    return "translate(" + d.y + "," + d.x + ")";
                })
                .attr("id", function(d) {return d.id;});

        // Draw every datum a small circle.
        node.append("circle")
                .attr("r", 4);

        // Setup G for every leaf datum.
        var leafNodeG = g.selectAll(".node--leaf")
                .append("g")
                .attr("class", "node--leaf-g")
                .attr("transform", "translate(" + 8 + "," + -10 + ")");

        leafNodeG.append("rect")
                .attr("class","shadow")
                .style("fill", function (d) {return d.data.color;})
                .attr("width", 2)
                .attr("height", 20)
                .attr("rx", 2)
                .attr("ry", 2)
                .transition()
                    .duration(800)
                    .attr("width", 200);

        leafNodeG.append("text")
                .attr("dy", 14.5)
                .attr("x", 8)
                .style("text-anchor", "start")
                .text(function (d) {
                    return d.data.id.substring(d.data.id.lastIndexOf(".") + 1);
                });
        leafNodeG.append("text")
                .attr("dy", 14.5)
                .attr("x", 100)
                .attr("id", "value")
                .style("text-anchor", "start")
                .text(function (d) {
                    return d.data.value;
                });
        leafNodeG.append("text")
                .attr("dy", 14.5)
                .attr("x", -50)
                .attr("id", "weight")
                .style("text-anchor", "start")
                .style('fill', 'black')
                .text(function (d) {
                    return d.data.weight;
                });

        // Write down text for every parent datum
        var internalNode = g.selectAll(".node--internal")
        internalNode.append("text")
                .attr("y", -10)
                .attr("id", function(d) {
                    return d.data.id
                })
                .style("text-anchor", "middle")
                .text(function (d) {
                    return d.data.id.substring(d.data.id.lastIndexOf(".") + 1);
                });

        var internalNodeMid = internalNode.filter(function(d) {
                    return d.data.id != "Price"
                });
        internalNodeMid.append("rect")
                .attr("class","shadow")
                .attr("y", 10)
                .attr("x", -60)
                .style("fill", function (d) {return d.data.color;})
                .attr("width", 2)
                .attr("height", 20)
                .attr("rx", 2)
                .attr("ry", 2)
                .transition()
                    .duration(800)
                    .attr("width", 120);
        internalNodeMid.append("text")
                .attr("y", 26)
                .attr("id", "value")
                .style("text-anchor", "middle")
                .text(function (d) {
                    return d.data.value;
                });
        internalNodeMid.append("text").filter(function(d) {
                    return d.data.id.split('.').length > 2
                })
                .attr("y", 26)
                .attr("x", 80)
                .attr("id", "time")
                .style("text-anchor", "left")
                .text(function (d) {
                    return "0s";
                });


    }
    draw(data)
    function row(d) {
        return {
            id: d.id,
            value: +d.value,
            color: d.color
        };
    }

    // node5
    async function fetchOracle(ip, oracleIndex, deltTime, ifTimeout=true) {
        update(data_clear, oracleIndex)
        fetch('https://oracles.increment.fi/node'+(oracleIndex+1), {method: 'GET', mode: 'cors'})
            .then(res => res.json())
            .then((state) => {
                console.log('Fetch state ', oracleIndex, state);
                update(state, oracleIndex)
        }).catch(err => {
            console.error(err)
            setTimeout(fetchOracle, 5000, ip, oracleIndex, deltTime, false)
        });

        if(ifTimeout) setTimeout(fetchOracle, deltTime, ip, oracleIndex, deltTime)
    }
    
    
    fetchOracle("52.32.72.92", 0, 60000)
    setTimeout(fetchOracle, 1500, "3.134.152.231", 1, 60000)
    setTimeout(fetchOracle, 3000, "3.140.163.242", 2, 60000)
    setTimeout(fetchOracle, 4500, "52.5.114.239", 3, 60000)
    setTimeout(fetchOracle, 6000, "34.225.183.58", 4, 60000)
</script>
